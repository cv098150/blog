---
layout: post
title: 實作30分鐘內登出系統
categories: work
tags: php
---

因資安需求，在後台毫無動作的時候經過了30分鐘需要自動登出系統，這邊用了JS的 `setTimeout()` 待30分後，導向到自動登出的連結，用PHP登出系統。

## HTML

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body data-limit-time="1800">
    </body>
</html>
```

## JS

```jsx
$(document).ready(function() {
        // 逾時登出
        let limitTime = parseInt($('body').data('limit-time'), 10) * 1000;
        if (limitTime!== undefined) {
            setTimeout(function () {
                window.location.href= '<?=$this->simpleUrl('index', 'index' ,'workbench')?>';
            }, limitTime);
        }
    });
```

## PHP

```php
public function indexAction()
{
		// 限制使用時間
    $limitTime = 60*30;
    $this->autoLogout($limitTime);
}

/**
* @param $limitTime
* @author maggie 2021/9/17 上午 11:09
*/
protected function autoLogout($limitTime)
{

  try {
      $loginTime = time();

      if (is_null($this->sessionGet(self::LOGIN_TIME))) {
          // 紀錄登入時間
          $this->sessionSet(self::LOGIN_TIME, $loginTime);
      }

      $timeStamp = $this->sessionGet(self::LOGIN_TIME);

      // 現在時間 - 登入時間 > 限制的時間
      if ($loginTime - $timeStamp > $limitTime) {

          // 清除使用者 session
          $this->clearUserSession();

          $this->setMessageIntoSession(self::MESSAGE_ERROR, '逾時登出');

          // 導向登入頁
          $this->_helper->redirector->gotoSimple('login');
      }

  } catch (Exception $e) {
      $this->setMessageIntoSession(self::MESSAGE_ERROR, $e->getMessage());
  }

}
```